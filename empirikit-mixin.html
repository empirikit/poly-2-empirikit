<script>

  const EmpirikitMixin = subclass => class extends subclass {

    static get config() {
      // properties, observers meta data
      return {
        properties: {
          device: {
            type: Object,
            observer: '_deviceChanged'
          }
        }
      };
    }

    connectedCallback() {
      super.connectedCallback();

      this.rstring = "";


      navigator.usb.getDevices()
      .then(availableDevices => {
        if(availableDevices.length){
          this.device = availableDevices[0];
          console.log("Device found:", this.device);
          return this.device.open(); // Begin a session.
        }
        throw "no device available yet";
      })
      .then(_ => this.device.selectConfiguration(1))
      .then(_ => this.device.claimInterface(2))
      .then(_ => this.device.controlTransferOut({
          requestType: 'class',
          recipient: 'interface',
          request: 0x22,
          value: 0x01,
          index: 0x02})) // Ready to receive data
      .then(_ => { this.readFromDevice(); }) // Waiting for 64 bytes of data from endpoint #5.
      .catch(error => { console.log(error); });
    }

    _deviceChanged(device, oldDevice) {
      console.log(`_deviceChanged ${oldDevice} => ${device}`);
    }

    _doScan() {
      var self = this;
      console.log("_doScan.");
      //navigator.usb.requestDevice({ filters: [{ vendorId: 0x0425 }] })
      navigator.usb.requestDevice({ filters: [{}] })
      .then(selectedDevice => {
         this.device = selectedDevice;
        console.log("Device found:", this.device);
         return this.device.open(); // Begin a session.
       })
      .then(_ => this.device.selectConfiguration(1))
      .then(_ => this.device.claimInterface(2))
      .then(_ => this.device.controlTransferOut({
          requestType: 'class',
          recipient: 'interface',
          request: 0x22,
          value: 0x01,
          index: 0x02})) // Ready to receive data
      .then(_ => { this.readFromDevice(); }) // Waiting for 64 bytes of data from endpoint #5.
      .catch(error => { console.log(error); });

    }

    readFromDevice() {
      this.device.transferIn(5, 64).then(result => {
        let decoder = new TextDecoder();
        this.rstring += decoder.decode(result.data);
        // do a quick JSON smoketest (should do better with decoder/streaming)
        let startb = (this.rstring.match(/{/g)||[]).length;
        let endb = (this.rstring.match(/}/g)||[]).length;
        if(startb > 0 && startb === endb) {
          try {
            let msg = JSON.parse(this.rstring);
            this.dispatchEvent(new CustomEvent('ek-event', {detail:msg}), {bubbles: true});
          } catch(e) {
            console.log("NOT JSON:",this.rstring);
          }
          this.rstring = "";
        }
        this.readFromDevice();
      })
      .catch(error => { console.log(error); this.device = null });
    }

    sendCMD(string) {
      console.log(`Sending to serial: [${string}]\n`);
      let data = new TextEncoder('utf-8').encode(string);
      console.log(data);
      if (this.device) {
        this.device.transferOut(5, data);
      }
    };


  };

</script>